openapi: 3.0.3
info:
  title: Hệ thống Quản lý Hồ sơ Đi Nước Ngoài - Trường Đại học Trà Vinh
  description: API cho hệ thống quản lý hồ sơ đi nước ngoài của viên chức
  version: 1.0.0
  contact:
    name: Phòng TCHC - Trường Đại học Trà Vinh
    email: admin@tvu.edu.vn

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.qlhs-dnn.tvu.edu.vn/api
    description: Production server

security:
  - bearerAuth: []

paths:
  # Authentication
  /auth/login:
    post:
      tags:
        - Authentication
      summary: Đăng nhập hệ thống
      description: Xác thực người dùng và trả về JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: "vc001"
                password:
                  type: string
                  example: "password123"
      responses:
        '200':
          description: Đăng nhập thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Sai thông tin đăng nhập

  # Hồ sơ đi nước ngoài
  /records:
    get:
      tags:
        - Hồ sơ
      summary: Lấy danh sách hồ sơ
      description: Lấy danh sách hồ sơ đi nước ngoài với phân trang và lọc
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
        - name: status
          in: query
          schema:
            type: integer
        - name: department
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Danh sách hồ sơ
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/HoSo'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
    post:
      tags:
        - Hồ sơ
      summary: Tạo hồ sơ mới
      description: Tạo hồ sơ đi nước ngoài mới
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateHoSoRequest'
      responses:
        '201':
          description: Hồ sơ đã được tạo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HoSo'
        '400':
          description: Dữ liệu không hợp lệ

  /records/{id}:
    get:
      tags:
        - Hồ sơ
      summary: Lấy chi tiết hồ sơ
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Chi tiết hồ sơ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HoSoDetail'
        '404':
          description: Không tìm thấy hồ sơ
    put:
      tags:
        - Hồ sơ
      summary: Cập nhật hồ sơ
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateHoSoRequest'
      responses:
        '200':
          description: Hồ sơ đã được cập nhật
        '403':
          description: Không có quyền cập nhật

  /records/{id}/approve:
    post:
      tags:
        - Phê duyệt
      summary: Phê duyệt hồ sơ
      description: Phê duyệt hồ sơ ở cấp tương ứng
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: level
          in: query
          required: true
          schema:
            type: integer
            enum: [1, 2, 3, 4, 5]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                comment:
                  type: string
                  example: "Đồng ý phê duyệt"
      responses:
        '200':
          description: Phê duyệt thành công
        '400':
          description: Không thể phê duyệt (chưa đủ điều kiện)

  /records/{id}/complete:
    post:
      tags:
        - Hồ sơ
      summary: Hoàn tất hồ sơ
      description: Đánh dấu hồ sơ đã hoàn tất (cần có báo cáo)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Hồ sơ đã hoàn tất
        '400':
          description: Chưa đủ điều kiện hoàn tất

  /records/{id}/decision:
    post:
      tags:
        - Quyết định
      summary: Tạo quyết định
      description: Ban hành quyết định cho hồ sơ đã được phê duyệt
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDecisionRequest'
      responses:
        '201':
          description: Quyết định đã được tạo
        '400':
          description: Chưa đủ phê duyệt để ban hành quyết định

  /records/{id}/report:
    post:
      tags:
        - Báo cáo
      summary: Nộp báo cáo sau chuyến đi
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReportRequest'
      responses:
        '201':
          description: Báo cáo đã được nộp
        '400':
          description: Dữ liệu báo cáo không hợp lệ

  # Tài liệu đính kèm
  /records/{id}/attachments:
    get:
      tags:
        - Tài liệu
      summary: Lấy danh sách tài liệu đính kèm
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
    post:
      tags:
        - Tài liệu
      summary: Upload tài liệu đính kèm
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                type:
                  type: integer
                  enum: [1, 2, 3, 4]
      responses:
        '201':
          description: Tài liệu đã được upload

  # Danh mục
  /catalogs/countries:
    get:
      tags:
        - Danh mục
      summary: Lấy danh sách quốc gia
      responses:
        '200':
          description: Danh sách quốc gia
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Country'

  /catalogs/purposes:
    get:
      tags:
        - Danh mục
      summary: Lấy danh sách mục đích chuyến đi
      responses:
        '200':
          description: Danh sách mục đích
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Purpose'

  # Thống kê
  /reports/summary:
    get:
      tags:
        - Thống kê
      summary: Thống kê tổng quan
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Dữ liệu thống kê
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportSummary'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
        username:
          type: string
        fullName:
          type: string
        department:
          type: string
        roles:
          type: array
          items:
            type: string

    HoSo:
      type: object
      properties:
        ho_so_id:
          type: string
        ma_ho_so:
          type: string
        vien_chuc:
          $ref: '#/components/schemas/VienChuc'
        muc_dich:
          $ref: '#/components/schemas/Purpose'
        quoc_gia:
          $ref: '#/components/schemas/Country'
        tu_ngay:
          type: string
          format: date
        den_ngay:
          type: string
          format: date
        trang_thai:
          $ref: '#/components/schemas/Status'
        ngay_tao:
          type: string
          format: date-time

    HoSoDetail:
      allOf:
        - $ref: '#/components/schemas/HoSo'
        - type: object
          properties:
            phe_duyets:
              type: array
              items:
                $ref: '#/components/schemas/PheDuyet'
            quyet_dinh:
              $ref: '#/components/schemas/QuyetDinh'
            bao_cao:
              $ref: '#/components/schemas/BaoCao'

    CreateHoSoRequest:
      type: object
      required:
        - vien_chuc_id
        - muc_dich_id
        - loai_chuyen_di_id
        - quoc_gia_id
        - tu_ngay
        - den_ngay
      properties:
        vien_chuc_id:
          type: string
        muc_dich_id:
          type: integer
        loai_chuyen_di_id:
          type: integer
        quoc_gia_id:
          type: integer
        tu_ngay:
          type: string
          format: date
        den_ngay:
          type: string
          format: date
        kinh_phi_du_kien:
          type: number
        ghi_chu:
          type: string

    UpdateHoSoRequest:
      type: object
      properties:
        muc_dich_id:
          type: integer
        quoc_gia_id:
          type: integer
        tu_ngay:
          type: string
          format: date
        den_ngay:
          type: string
          format: date
        kinh_phi_du_kien:
          type: number
        ghi_chu:
          type: string

    CreateDecisionRequest:
      type: object
      required:
        - so_quyet_dinh
        - ngay_ky
        - nguoi_ky
      properties:
        so_quyet_dinh:
          type: string
        ngay_ky:
          type: string
          format: date
        nguoi_ky:
          type: string
        loai_quyet_dinh_id:
          type: integer
          default: 1

    CreateReportRequest:
      type: object
      required:
        - noi_dung
      properties:
        noi_dung:
          type: string
        ket_qua_chuyen_di:
          type: string
        de_xuat_kien_nghi:
          type: string

    VienChuc:
      type: object
      properties:
        vien_chuc_id:
          type: string
        ma_vien_chuc:
          type: string
        ho_ten:
          type: string
        don_vi:
          type: string

    Purpose:
      type: object
      properties:
        id:
          type: integer
        ten:
          type: string

    Country:
      type: object
      properties:
        quoc_gia_id:
          type: integer
        ten:
          type: string

    Status:
      type: object
      properties:
        trang_thai_id:
          type: integer
        ten:
          type: string

    PheDuyet:
      type: object
      properties:
        cap_phe_duyet:
          type: string
        nguoi_duyet:
          type: string
        ket_qua:
          type: boolean
        thoi_diem_duyet:
          type: string
          format: date-time
        y_kien:
          type: string

    QuyetDinh:
      type: object
      properties:
        so_quyet_dinh:
          type: string
        ngay_ky:
          type: string
          format: date
        nguoi_ky:
          type: string

    BaoCao:
      type: object
      properties:
        noi_dung:
          type: string
        ket_qua_chuyen_di:
          type: string
        de_xuat_kien_nghi:
          type: string
        ngay_nop:
          type: string
          format: date

    ReportSummary:
      type: object
      properties:
        total_records:
          type: integer
        pending_approval:
          type: integer
        approved:
          type: integer
        completed:
          type: integer
        rejected:
          type: integer